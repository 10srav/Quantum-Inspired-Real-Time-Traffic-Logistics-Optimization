# =============================================================================
# Quantum Traffic Optimizer - Docker Compose
# =============================================================================
# Full production stack with:
# - FastAPI Application
# - PostgreSQL Database
# - Redis Cache
# - Prometheus Monitoring
# - Grafana Dashboards
# - Streamlit Frontend (optional)
# =============================================================================

version: '3.8'

services:
  # ===========================================================================
  # FastAPI Application
  # ===========================================================================
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: quantum-traffic-api
    restart: unless-stopped
    ports:
      - "${API_PORT:-8000}:8000"
    environment:
      # Application
      - APP_NAME=Quantum Traffic Optimizer
      - APP_VERSION=1.0.0
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - DEBUG=${DEBUG:-false}
      # Server
      - HOST=0.0.0.0
      - PORT=8000
      - WORKERS=${WORKERS:-4}
      # Security
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-development-secret-change-in-production}
      - API_KEYS_ENABLED=${API_KEYS_ENABLED:-false}
      - VALID_API_KEYS=${VALID_API_KEYS:-}
      - RATE_LIMIT_ENABLED=true
      - RATE_LIMIT_PER_MINUTE=60
      # CORS
      - CORS_ORIGINS=http://localhost:3000,http://localhost:8501
      # Database
      - DATABASE_ENABLED=true
      - DATABASE_URL=postgresql+asyncpg://quantum:quantum123@postgres:5432/quantum_traffic
      - DATABASE_POOL_SIZE=20
      # Redis
      - REDIS_ENABLED=true
      - REDIS_URL=redis://:redis123@redis:6379/0
      # Monitoring
      - METRICS_ENABLED=true
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FORMAT=${LOG_FORMAT:-json}
      # OSM
      - OSM_USE_CACHE=true
      - OSM_CACHE_DIR=/app/data
      - OSM_DEMO_MODE=${OSM_DEMO_MODE:-false}
      # QAOA
      - USE_QAOA_IN_API=${USE_QAOA_IN_API:-false}
      - QAOA_LAYERS=3
    volumes:
      - graph-cache:/app/data
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - quantum-network
    labels:
      - "prometheus.scrape=true"
      - "prometheus.port=8000"
      - "prometheus.path=/metrics"

  # ===========================================================================
  # PostgreSQL Database
  # ===========================================================================
  postgres:
    image: postgres:15-alpine
    container_name: quantum-traffic-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=quantum
      - POSTGRES_PASSWORD=quantum123
      - POSTGRES_DB=quantum_traffic
      - PGDATA=/var/lib/postgresql/data/pgdata
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U quantum -d quantum_traffic"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - quantum-network

  # ===========================================================================
  # Redis Cache
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: quantum-traffic-redis
    restart: unless-stopped
    command: redis-server --requirepass redis123 --appendonly yes
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "redis123", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - quantum-network

  # ===========================================================================
  # Prometheus Monitoring
  # ===========================================================================
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: quantum-traffic-prometheus
    restart: unless-stopped
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./monitoring/alerts.yml:/etc/prometheus/alerts.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'
      - '--web.enable-lifecycle'
    networks:
      - quantum-network

  # ===========================================================================
  # Grafana Dashboards
  # ===========================================================================
  grafana:
    image: grafana/grafana:10.2.2
    container_name: quantum-traffic-grafana
    restart: unless-stopped
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin123}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=http://localhost:3000
    volumes:
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
      - grafana-data:/var/lib/grafana
    depends_on:
      - prometheus
    networks:
      - quantum-network

  # ===========================================================================
  # Streamlit Frontend (Optional)
  # ===========================================================================
  streamlit:
    build:
      context: .
      dockerfile: Dockerfile.streamlit
    container_name: quantum-traffic-ui
    restart: unless-stopped
    ports:
      - "${STREAMLIT_PORT:-8501}:8501"
    environment:
      - API_URL=http://api:8000
    depends_on:
      api:
        condition: service_healthy
    networks:
      - quantum-network
    profiles:
      - frontend

  # ===========================================================================
  # Database Admin (Optional - for development)
  # ===========================================================================
  pgadmin:
    image: dpage/pgadmin4:8
    container_name: quantum-traffic-pgadmin
    restart: unless-stopped
    ports:
      - "${PGADMIN_PORT:-5050}:80"
    environment:
      - PGADMIN_DEFAULT_EMAIL=${PGADMIN_EMAIL:-admin@quantum.local}
      - PGADMIN_DEFAULT_PASSWORD=${PGADMIN_PASSWORD:-admin123}
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    depends_on:
      - postgres
    networks:
      - quantum-network
    profiles:
      - dev

  # ===========================================================================
  # Redis Commander (Optional - for development)
  # ===========================================================================
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: quantum-traffic-redis-ui
    restart: unless-stopped
    ports:
      - "${REDIS_COMMANDER_PORT:-8081}:8081"
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=redis123
    depends_on:
      - redis
    networks:
      - quantum-network
    profiles:
      - dev

# =============================================================================
# Networks
# =============================================================================
networks:
  quantum-network:
    driver: bridge
    name: quantum-traffic-network

# =============================================================================
# Volumes
# =============================================================================
volumes:
  postgres-data:
    driver: local
  redis-data:
    driver: local
  prometheus-data:
    driver: local
  grafana-data:
    driver: local
  pgadmin-data:
    driver: local
  graph-cache:
    driver: local
